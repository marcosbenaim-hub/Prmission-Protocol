<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Prmission Protocol — Live on Base</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0c0e;--bg2:#0f1316;--card:#151a1e;--card2:#1a2126;--card3:#1f282e;--border:#232c33;--border2:#2a3540;--green:#00ff7f;--green2:#00e070;--gdim:rgba(0,255,127,.07);--gb:rgba(0,255,127,.20);--gb2:rgba(0,255,127,.35);--white:#f0f4f6;--text:#c8d8e2;--text2:#6a8090;--text3:#364856;--red:#ff4444;--yellow:#ffd60a;--purple:#a855f7;--orange:#f97316;--mono:'IBM Plex Mono',monospace;--sans:'IBM Plex Sans',sans-serif;}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;touch-action:manipulation}
.page-header{text-align:center;padding:24px 20px 16px}
.page-brand{font-family:var(--mono);font-size:20px;font-weight:700;color:var(--green);letter-spacing:.2em}
.page-sub{font-family:var(--mono);font-size:11px;color:var(--text2);margin-top:5px;letter-spacing:.04em}
.layout{display:flex;gap:18px;padding:0 18px 24px;max-width:960px;margin:0 auto;align-items:flex-start}
.phone-wrap{flex-shrink:0;width:285px}
.phone{background:#111518;border-radius:42px;border:2px solid #252e36;box-shadow:0 0 0 1px #161d24,0 40px 100px rgba(0,0,0,.7),inset 0 1px 0 rgba(255,255,255,.04);overflow:hidden;position:relative}
.phone-status{display:flex;align-items:center;justify-content:space-between;padding:10px 22px 6px;background:#111518}
.ps-time{font-family:var(--mono);font-size:13px;font-weight:600;color:var(--white)}
.ps-icons{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--white)}
.ps-battery{width:22px;height:11px;border:1.5px solid var(--white);border-radius:2px;position:relative;padding:1.5px}
.ps-battery::after{content:'';position:absolute;right:-4px;top:50%;transform:translateY(-50%);width:2px;height:5px;background:var(--white);border-radius:0 1px 1px 0}
.ps-battery-fill{background:var(--green);height:100%;width:70%;border-radius:1px}
.phone-screen{min-height:400px;background:#111518;overflow:hidden;position:relative}
.pscreen{display:none;padding:12px 14px 10px}
.pscreen.active{display:block}

/* WALLET */
.ws-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.ws-title{font-size:18px;font-weight:700;color:var(--white)}
.ws-brand{font-family:var(--mono);font-size:12px;font-weight:700;color:var(--green)}
.ws-total-label{font-family:var(--mono);font-size:9px;color:var(--text3);text-align:center;letter-spacing:.12em;text-transform:uppercase;margin-bottom:3px}
.ws-amount{font-family:var(--mono);font-size:38px;font-weight:700;color:var(--green);text-align:center;line-height:1;transition:color .2s}
.ws-amount.flash{color:#fff}
.ws-usdc{font-family:var(--mono);font-size:10px;color:var(--text3);text-align:center;margin-top:4px;margin-bottom:12px}
.ws-badges{display:flex;gap:5px;justify-content:center;margin-bottom:14px}
.ws-badge{border-radius:4px;padding:3px 7px;font-family:var(--mono);font-size:8px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;border:1px solid;text-align:center}
.wb-live{background:var(--gdim);border-color:var(--gb);color:var(--green)}
.wb-pct{background:rgba(168,85,247,.1);border-color:rgba(168,85,247,.3);color:var(--purple)}
.wb-set{background:rgba(249,115,22,.1);border-color:rgba(249,115,22,.3);color:var(--orange)}
.ws-section-label{font-family:var(--mono);font-size:9px;font-weight:700;color:var(--green);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:5px}
.live-dot{width:5px;height:5px;border-radius:50%;background:var(--green);animation:ldot 1.5s ease-in-out infinite;flex-shrink:0}
@keyframes ldot{0%,100%{opacity:1}50%{opacity:.2}}
.settle-list{display:flex;flex-direction:column;gap:4px;max-height:230px;overflow-y:auto}
.settle-list::-webkit-scrollbar{width:2px}
.settle-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.si{display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--card2);border:1px solid var(--border);border-radius:6px;transition:all .3s}
.si.new-entry{border-color:var(--gb);background:var(--gdim);animation:popIn .4s ease}
@keyframes popIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.si-ico{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.si-info{flex:1;min-width:0}
.si-name{font-size:11px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.si-meta{font-family:var(--mono);font-size:8px;color:var(--text3);margin-top:1px}
.si-amt{font-family:var(--mono);font-size:11px;font-weight:700;flex-shrink:0;text-align:right}
.si-amt.pos{color:var(--green)}
.si-amt.neg{color:var(--red)}

/* DATA LOCKER */
.ds-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
.ds-title{font-size:18px;font-weight:700;color:var(--white)}
.ds-sub{font-family:var(--mono);font-size:8px;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;margin-bottom:12px}
.data-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.data-card{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:10px 11px 9px;transition:border-color .3s,background .3s;cursor:pointer;user-select:none;touch-action:manipulation}
.data-card.enabled{border-color:var(--gb);background:var(--gdim)}
.data-card.wide{grid-column:1 / -1}
.dc-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.dc-icon{font-size:18px}
.toggle{width:44px;height:26px;background:var(--border2);border-radius:13px;position:relative;cursor:pointer;transition:background .25s;flex-shrink:0}
.toggle.on{background:var(--green)}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:20px;height:20px;background:var(--white);border-radius:50%;transition:transform .25s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.toggle.on::after{transform:translateX(18px)}
.dc-name{font-size:11px;font-weight:600;color:var(--text)}
.dc-fee{font-family:var(--mono);font-size:8px;color:var(--text3);margin-top:2px}

/* EARN */
.es-avail-label{font-family:var(--mono);font-size:8px;color:var(--text3);text-transform:uppercase;letter-spacing:.12em;text-align:center;margin-bottom:3px}
.es-amount{font-family:var(--mono);font-size:34px;font-weight:700;color:var(--green);text-align:center;line-height:1;transition:color .2s}
.es-amount.flash{color:#fff}
.es-usdc{font-family:var(--mono);font-size:10px;color:var(--text3);text-align:center;margin-top:4px;margin-bottom:12px}
.withdraw-bar{background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:9px 11px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.wb-text{font-family:var(--mono);font-size:9px;color:var(--text2);flex:1}
.wb-status{font-family:var(--mono);font-size:8px;color:var(--green);animation:ldot 1.5s infinite}
.withdraw-flow{display:flex;align-items:flex-start;gap:3px;justify-content:center;margin-bottom:12px}
.wf-col{display:flex;flex-direction:column;align-items:center;gap:2px}
.wf-step{width:26px;height:26px;border-radius:50%;background:var(--card2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px}
.wf-step.active{border-color:var(--gb);background:var(--gdim)}
.wf-arrow{font-size:10px;color:var(--text3);padding-top:8px}
.wf-label{font-family:var(--mono);font-size:7px;color:var(--text3);text-align:center}
.earn-section-label{font-family:var(--mono);font-size:9px;font-weight:700;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px}
.agent-earn-list{display:flex;flex-direction:column;gap:4px}
.ae-item{display:flex;align-items:center;gap:8px;padding:7px 8px;background:var(--card2);border:1px solid var(--border);border-radius:6px}
.ae-ico{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.ae-info{flex:1}
.ae-name{font-size:11px;font-weight:600;color:var(--text)}
.ae-fee{font-family:var(--mono);font-size:8px;color:var(--text3);margin-top:1px}
.ae-amt{font-family:var(--mono);font-size:12px;font-weight:700;color:var(--green)}
.earn-footer{margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
.ef-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0}
.ef-l{font-size:11px;color:var(--text2)}
.ef-r{font-family:var(--mono);font-size:11px;color:var(--green);font-weight:600}

/* ACTIVITY */
.act-section-label{font-family:var(--mono);font-size:9px;font-weight:700;color:var(--green);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:5px}
.act-list{display:flex;flex-direction:column;gap:4px;max-height:350px;overflow-y:auto}
.act-list::-webkit-scrollbar{width:2px}
.act-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.act-item{display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--card2);border:1px solid var(--border);border-radius:6px;animation:popIn .4s ease}
.act-ico{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.act-info{flex:1;min-width:0}
.act-name{font-size:11px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.act-meta{font-family:var(--mono);font-size:8px;margin-top:1px}
.act-amt{font-family:var(--mono);font-size:11px;font-weight:700;flex-shrink:0}

/* PHONE NAV */
.phone-nav{display:flex;border-top:1px solid var(--border);background:#111518;padding:6px 2px 12px}
.pnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 4px;min-height:48px;border:none;background:transparent;cursor:pointer;border-radius:8px;transition:all .2s;touch-action:manipulation}
.pn-icon{font-size:17px;color:var(--text3);transition:color .2s}
.pn-label{font-family:var(--mono);font-size:8px;color:var(--text3);transition:color .2s}
.pnav-btn.active .pn-icon,.pnav-btn.active .pn-label{color:var(--green)}

/* CONNECT OVERLAY */
.connect-overlay{position:absolute;inset:0;background:rgba(10,12,14,.92);backdrop-filter:blur(8px);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:20px;z-index:10;border-radius:40px}
.connect-overlay h3{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--green);letter-spacing:.08em;text-align:center}
.connect-overlay p{font-size:11px;color:var(--text2);text-align:center;line-height:1.6}
.conn-btn{width:100%;padding:13px 11px;min-height:46px;background:var(--green);color:#000;border:none;border-radius:8px;font-family:var(--mono);font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:8px;touch-action:manipulation}
.conn-btn:hover{background:var(--green2)}
.conn-btn.outline{background:transparent;border:1px solid var(--border2);color:var(--text2)}
.conn-btn.outline:hover{border-color:var(--gb);color:var(--green)}
.conn-note{font-family:var(--mono);font-size:8px;color:var(--text3);text-align:center;line-height:1.6}
.swipe-tip{margin-top:8px;font-family:var(--mono);font-size:8px;color:var(--text3);letter-spacing:.06em}
.conn-btn.hidden{display:none}

/* RIGHT PANEL */
.right-panel{flex:1;display:flex;flex-direction:column;gap:10px}
.rcard{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.rcard.green-tint{background:var(--gdim);border-color:var(--gb)}
.rcard-head{padding:10px 14px 8px;border-bottom:1px solid var(--border)}
.rcard-head h3{font-family:var(--mono);font-size:10px;font-weight:700;color:var(--green);letter-spacing:.1em;text-transform:uppercase}
.rcard-head p{font-size:12px;color:var(--text2);margin-top:4px;line-height:1.5}
.rcard-body{padding:12px 14px}
.uw-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.uw-ava{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--green),#003d1a);border:1px solid var(--gb2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:14px}
.uw-name{font-size:13px;font-weight:600;color:var(--text)}
.uw-addr{font-family:var(--mono);font-size:9px;color:var(--text3);margin-top:2px}
.uw-amount{font-family:var(--mono);font-size:32px;font-weight:700;color:var(--green);transition:all .3s;margin-bottom:3px}
.uw-amount.flash{color:#fff;transform:scale(1.03)}
.uw-label{font-size:11px;color:var(--text2)}
.fee-arrow{text-align:center;padding:4px 0;display:flex;flex-direction:column;align-items:center;gap:3px}
.fee-pill{background:var(--card2);border:1px solid var(--border2);border-radius:100px;padding:3px 10px;font-family:var(--mono);font-size:10px;color:var(--text2)}
.fee-down{font-size:16px;color:var(--text3)}
.ow-ava{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#ffd60a,#7a4500);border:1px solid rgba(255,214,10,.3);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:14px}
.ow-amount{font-family:var(--mono);font-size:30px;font-weight:700;color:var(--green);transition:all .3s;margin-bottom:3px}
.ow-amount.flash{color:#fff}
.ow-receiving{font-family:var(--mono);font-size:10px;color:var(--green);margin-top:6px;animation:ldot 1.5s infinite;display:none}
.ow-receiving.show{display:block}
.stats-grid{display:flex;flex-direction:column;gap:0}
.stat-row2{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)}
.stat-row2:last-child{border-bottom:none}
.sr-l{font-size:11px;color:var(--text2)}
.sr-r{font-family:var(--mono);font-size:11px;font-weight:600;color:var(--green)}
.every-settle{background:var(--card2);border:1px solid var(--border2);border-radius:8px;padding:10px 12px}
.es-title2{font-family:var(--mono);font-size:9px;font-weight:700;color:var(--green);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px}
.es-row2{font-family:var(--mono);font-size:10px;color:var(--text2);padding:2px 0}
.es-row2 .g{color:var(--green);font-weight:600}
.es-note2{font-family:var(--mono);font-size:9px;color:var(--text3);margin-top:6px}
.pill-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
.pill{flex:1;min-width:64px;background:transparent;border:1px solid var(--border2);border-radius:5px;padding:7px 10px;text-align:center}
.pv{font-family:var(--mono);font-size:11px;font-weight:700;color:var(--text)}
.pl{font-family:var(--mono);font-size:7px;color:var(--text3);margin-top:2px;text-transform:uppercase;letter-spacing:.08em}
.p-credit{font-family:var(--mono);font-size:9px;color:var(--text3);text-align:center;margin-top:6px}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(5,7,9,.85);backdrop-filter:blur(12px);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
.overlay.open{display:flex}
.modal{background:var(--card);border:1px solid var(--border2);border-radius:12px;width:100%;max-width:360px;padding:22px;animation:mup .25s ease}
@keyframes mup{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.modal-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.modal-hd h3{font-family:var(--mono);font-size:12px;font-weight:700;color:var(--green);letter-spacing:.08em}
.modal-x{width:34px;height:34px;border:none;background:transparent;border-radius:6px;font-size:20px;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:manipulation}
.modal-x:hover{background:var(--card2);color:var(--text)}
.wopts{display:flex;flex-direction:column;gap:7px}
.wopt{display:flex;align-items:center;gap:11px;background:var(--bg2);border:1px solid var(--border2);border-radius:8px;padding:13px 14px;min-height:56px;cursor:pointer;transition:all .15s;touch-action:manipulation}
.wopt:hover{border-color:var(--gb);background:var(--card2)}
.wopt-ico{width:38px;height:38px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0}
.wopt-ico.mm{background:rgba(247,147,26,.1)}
.wopt-ico.cb{background:rgba(0,82,255,.1)}
.wopt-ico.gen{background:var(--card3)}
.wopt-txt h4{font-size:13px;font-weight:600;color:var(--text)}
.wopt-txt p{font-size:11px;color:var(--text3);margin-top:2px}
.modal-note{font-family:var(--mono);font-size:9px;color:var(--text3);text-align:center;margin-top:12px;line-height:1.7}
.tx-body{text-align:center;padding:16px 0 10px}
.tx-spin{width:44px;height:44px;margin:0 auto 14px;border:2px solid var(--border2);border-top-color:var(--green);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.tx-ok,.tx-err{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;margin:0 auto 14px}
.tx-ok{background:var(--gdim);border:2px solid var(--gb);color:var(--green)}
.tx-err{background:rgba(255,68,68,.1);border:2px solid rgba(255,68,68,.3);color:var(--red)}
.tx-msg{font-size:14px;font-weight:600;color:var(--text);margin-bottom:5px}
.tx-sub{font-family:var(--mono);font-size:10px;color:var(--text3);word-break:break-all}
.tx-close-btn{width:100%;margin-top:10px;padding:12px;background:transparent;border:1px solid var(--border2);border-radius:7px;font-family:var(--mono);font-size:11px;color:var(--text2);cursor:pointer;touch-action:manipulation}
.tx-close-btn:hover{border-color:var(--gb);color:var(--green)}
.toast{position:fixed;bottom:20px;right:20px;z-index:2000;background:var(--card2);border:1px solid var(--border2);border-radius:7px;padding:10px 14px;font-family:var(--mono);font-size:11px;max-width:300px;box-shadow:0 8px 30px rgba(0,0,0,.5);display:none}
.toast.show{display:block;animation:mup .3s ease}
.toast.ok{border-color:var(--gb);color:var(--green)}
.toast.err{border-color:rgba(255,68,68,.3);color:var(--red)}
.hidden{display:none!important}
@media(max-width:680px){
  .page-header{padding:16px 14px 10px}
  .layout{flex-direction:column;align-items:center;gap:10px;padding:0 10px 16px}
  .phone-wrap{width:100%;max-width:420px}
  .phone{border-radius:26px}
  .phone-screen{min-height:470px}
  .pscreen{padding:14px 14px 12px}
  .page-brand{font-size:18px}
  .right-panel{width:100%}
  body{padding-bottom:env(safe-area-inset-bottom)}
}
</style>
</head>
<body>

<div class="page-header">
  <div class="page-brand">PRMISSION</div>
  <div class="page-sub">The economic layer for AI agent commerce</div>
</div>

<div class="layout">

  <!-- PHONE -->
  <div class="phone-wrap">
    <div class="phone">
      <div class="phone-status">
        <div class="ps-time">9:41</div>
        <div class="ps-icons">
          <span>&#9652;</span>
          <div class="ps-battery"><div class="ps-battery-fill"></div></div>
        </div>
      </div>

      <div class="phone-screen">

        <!-- WALLET SCREEN -->
        <div class="pscreen active" id="screen-wallet">
          <div class="ws-header">
            <div class="ws-title">Wallet</div>
            <div class="ws-brand">Prmission</div>
          </div>
          <div class="ws-total-label">TOTAL EARNED</div>
          <div class="ws-amount" id="phoneAmount">$0.00</div>
          <div class="ws-usdc">USDC on Base</div>
          <div class="ws-badges">
            <div class="ws-badge wb-live">LIVE<br>BASE MAINNET</div>
            <div class="ws-badge wb-pct">3%<br>PROTOCOL FEE</div>
            <div class="ws-badge wb-set">~3s<br>SETTLEMENT</div>
          </div>
          <div class="ws-section-label"><div class="live-dot"></div>RECENT SETTLEMENTS</div>
          <div class="settle-list" id="settleList"></div>
        </div>

        <!-- DATA LOCKER SCREEN -->
        <div class="pscreen" id="screen-data">
          <div class="ds-header">
            <div class="ds-title">Data Locker</div>
            <div class="ws-brand">Prmission</div>
          </div>
          <div class="ds-sub">DATA LOCKER</div>
          <div class="data-grid" id="dataGrid"></div>
        </div>

        <!-- EARN SCREEN -->
        <div class="pscreen" id="screen-earn">
          <div class="ws-header">
            <div class="ws-title">Earnings</div>
            <div class="ws-brand">Prmission</div>
          </div>
          <div class="es-avail-label">AVAILABLE TO WITHDRAW</div>
          <div class="es-amount" id="earnAmount">$0.00</div>
          <div class="es-usdc">USDC on Base</div>
          <div class="withdraw-bar">
            <span style="font-size:14px">&#128179;</span>
            <div class="wb-text" id="wbText">Converting USDC &#8594; USD...</div>
            <div class="wb-status">&#9679; LIVE</div>
          </div>
          <div class="withdraw-flow">
            <div class="wf-col"><div class="wf-step active">$</div><div class="wf-label">USDC</div></div>
            <div class="wf-arrow">&#8594;</div>
            <div class="wf-col"><div class="wf-step active">&#9889;</div><div class="wf-label">Base</div></div>
            <div class="wf-arrow">&#8594;</div>
            <div class="wf-col"><div class="wf-step">&#127970;</div><div class="wf-label">USD</div></div>
            <div class="wf-arrow">&#8594;</div>
            <div class="wf-col"><div class="wf-step">&#128100;</div><div class="wf-label">Bank</div></div>
          </div>
          <div class="earn-section-label">EARNINGS BY AGENT</div>
          <div class="agent-earn-list" id="agentEarnList"></div>
          <div class="earn-footer">
            <div class="ef-row"><span class="ef-l">Your earnings (user fees)</span><span class="ef-r" id="efUser">$0.00</span></div>
            <div class="ef-row"><span class="ef-l">Protocol collected (3%)</span><span class="ef-r" id="efProto">$0.00</span></div>
          </div>
        </div>

        <!-- ACTIVITY SCREEN -->
        <div class="pscreen" id="screen-activity">
          <div class="ws-header">
            <div class="ws-title">Activity</div>
            <div class="ws-brand">Prmission</div>
          </div>
          <div class="act-section-label"><div class="live-dot"></div>LIVE SETTLEMENTS</div>
          <div class="act-list" id="activityList"></div>
        </div>

        <!-- CONNECT OVERLAY -->
        <div class="connect-overlay" id="connectOverlay">
          <div style="font-size:32px">&#128272;</div>
          <h3>Connect Your Wallet</h3>
          <p>Connect to Base Mainnet to start earning USDC from AI agents accessing your data.</p>
          <button class="conn-btn" onclick="openWalletModal()">
          <svg width="18" height="18" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg" style="border-radius:4px"><rect width="1024" height="1024" rx="180" fill="#0052FF"/><path d="M512 128C300.8 128 128 300.8 128 512C128 723.2 300.8 896 512 896C723.2 896 896 723.2 896 512C896 300.8 723.2 128 512 128ZM512 684.8C406.4 684.8 320 598.4 320 492.8C320 387.2 406.4 300.8 512 300.8C617.6 300.8 704 387.2 704 492.8C704 598.4 617.6 684.8 512 684.8Z" fill="white"/><rect x="428" y="448" width="168" height="89.6" rx="22" fill="white"/></svg>
          Connect Coinbase Wallet
        </button>
          <button class="conn-btn hidden" id="openInCoinbaseBtn" onclick="openInCoinbaseWallet()">Open in Coinbase Wallet</button>
          <button class="conn-btn outline" style="margin-top:4px" onclick="openWalletModal()">&#128091; Other Wallet</button>
          <div class="conn-note">Prmission Protocol &#183; Base Mainnet<br>0x0c8B16a...969223d &#183; Verified</div>
          <div class="swipe-tip">Swipe left/right to navigate tabs after connecting</div>
        </div>

      </div><!-- /phone-screen -->

      <div class="phone-nav">
        <button class="pnav-btn active" data-s="wallet" onclick="switchScreen('wallet',this)">
          <div class="pn-icon">&#9672;</div><div class="pn-label">Wallet</div>
        </button>
        <button class="pnav-btn" data-s="data" onclick="switchScreen('data',this)">
          <div class="pn-icon">&#8962;</div><div class="pn-label">Data</div>
        </button>
        <button class="pnav-btn" data-s="earn" onclick="switchScreen('earn',this)">
          <div class="pn-icon">$</div><div class="pn-label">Earn</div>
        </button>
        <button class="pnav-btn" data-s="activity" onclick="switchScreen('activity',this)">
          <div class="pn-icon">&#8644;</div><div class="pn-label">Activity</div>
        </button>
      </div>
    </div>
  </div><!-- /phone-wrap -->

  <!-- RIGHT PANEL -->
  <div class="right-panel">

    <div class="rcard green-tint">
      <div class="rcard-head">
        <h3>Money Flow</h3>
        <p>Every settlement splits fees on-chain in real time</p>
      </div>
    </div>

    <div class="rcard">
      <div class="rcard-body">
        <div class="uw-row">
          <div class="uw-ava">&#128100;</div>
          <div>
            <div class="uw-name">User Wallet</div>
            <div class="uw-addr" id="rpAddr">0x7a3F...e91B</div>
          </div>
        </div>
        <div class="uw-amount" id="rpUserAmt">$0.00</div>
        <div class="uw-label">USDC earned from data permissions</div>
      </div>
    </div>

    <div class="fee-arrow">
      <div class="fee-pill">3% protocol fee</div>
      <div class="fee-down">&#8595;</div>
    </div>

    <div class="rcard green-tint">
      <div class="rcard-body">
        <div class="uw-row">
          <div class="ow-ava">&#128081;</div>
          <div>
            <div class="uw-name" style="color:var(--green)">Owner Wallet</div>
            <div class="uw-addr">0x0c8B...223d &#183; Base</div>
          </div>
        </div>
        <div class="ow-amount" id="rpOwnerAmt">$0.00</div>
        <div class="uw-label">3% of every settlement &#8594; your wallet</div>
        <div class="ow-receiving" id="owRecv">&#9679; Receiving funds...</div>
      </div>
    </div>

    <div class="rcard">
      <div class="rcard-body">
        <div class="stats-grid">
          <div class="stat-row2"><span class="sr-l">Settlements</span><span class="sr-r" id="rpSett">0</span></div>
          <div class="stat-row2"><span class="sr-l">User earned</span><span class="sr-r" id="rpUE">$0.00</span></div>
          <div class="stat-row2"><span class="sr-l">Owner collected (3%)</span><span class="sr-r" id="rpOC">$0.00</span></div>
          <div class="stat-row2"><span class="sr-l">Verify: 3% of user</span><span class="sr-r" id="rpV">$0.00</span></div>
        </div>
      </div>
    </div>

    <div class="rcard">
      <div class="rcard-body">
        <div class="every-settle">
          <div class="es-title2">EVERY SETTLEMENT</div>
          <div class="es-row2">Agent pays &#8594; Smart Contract</div>
          <div class="es-row2">&#8594; User gets their fee</div>
          <div class="es-row2"><span class="g">&#8594; 3% &#8594; Owner Wallet</span></div>
          <div class="es-row2">&#8594; Agent gets remainder</div>
          <div class="es-note2">All on-chain &#183; Immutable &#183; Base L2</div>
        </div>
        <div class="pill-row">
          <div class="pill"><div class="pv">COSS</div><div class="pl">Open Source</div></div>
          <div class="pill"><div class="pv">3%</div><div class="pl">Hardcoded</div></div>
          <div class="pill"><div class="pv">Base</div><div class="pl">ID: 8453</div></div>
        </div>
        <div class="p-credit">prmission.com</div>
      </div>
    </div>

  </div>
</div>

<!-- WALLET MODAL -->
<div class="overlay" id="walletModal" onclick="if(event.target.id==='walletModal')closeModal('walletModal')">
  <div class="modal">
    <div class="modal-hd">
      <h3>CONNECT WALLET</h3>
      <button class="modal-x" onclick="closeModal('walletModal')">&#215;</button>
    </div>
    <div class="wopts">
      <div class="wopt" onclick="connectWallet('coinbase')">
        <div class="wopt-ico cb" style="background:#fff;border-radius:10px;padding:2px">
          <svg width="34" height="34" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="1024" height="1024" rx="200" fill="#0052FF"/>
            <path d="M512 128C300.8 128 128 300.8 128 512C128 723.2 300.8 896 512 896C723.2 896 896 723.2 896 512C896 300.8 723.2 128 512 128ZM512 684.8C406.4 684.8 320 598.4 320 492.8C320 387.2 406.4 300.8 512 300.8C617.6 300.8 704 387.2 704 492.8C704 598.4 617.6 684.8 512 684.8Z" fill="white"/>
            <rect x="428" y="448" width="168" height="89.6" rx="22" fill="white"/>
          </svg>
        </div>
        <div class="wopt-txt"><h4>Coinbase Wallet</h4><p>Recommended for Base &mdash; most popular</p></div>
      </div>
      <div class="wopt" onclick="connectWallet('injected')">
        <div class="wopt-ico gen">&#128091;</div>
        <div class="wopt-txt"><h4>Browser Wallet</h4><p>Any Web3 provider</p></div>
      </div>
    </div>
    <div class="modal-note">Prmission Protocol &#183; Base Mainnet &#183; Chain ID: 8453<br>0x0c8B16a57524f4009581B748356E01e1a969223d</div>
  </div>
</div>

<!-- TX MODAL -->
<div class="overlay" id="txModal">
  <div class="modal" style="max-width:360px">
    <div class="modal-hd">
      <h3 id="txTitle">TRANSACTION</h3>
      <button class="modal-x" onclick="closeModal('txModal')">&#215;</button>
    </div>
    <div class="tx-body">
      <div id="txSpin" class="tx-spin"></div>
      <div id="txOkIco" class="tx-ok hidden">&#10003;</div>
      <div id="txErrIco" class="tx-err hidden">&#10005;</div>
      <div class="tx-msg" id="txMsg">Waiting...</div>
      <div class="tx-sub" id="txSub">Please confirm in your wallet</div>
    </div>
    <button class="tx-close-btn hidden" id="txClose" onclick="closeModal('txModal')">Close</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
<script>
'use strict';
const CA='0x0c8B16a57524f4009581B748356E01e1a969223d';
const USDC_ADDR='0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
const BASE=8453,BASE_HEX='0x2105';
const ABI=[{"inputs":[{"internalType":"address","name":"merchant","type":"address"},{"internalType":"string","name":"dataCategory","type":"string"},{"internalType":"string","name":"purpose","type":"string"},{"internalType":"uint256","name":"compensationBps","type":"uint256"},{"internalType":"uint256","name":"upfrontFee","type":"uint256"},{"internalType":"uint256","name":"validityPeriod","type":"uint256"}],"name":"grantPermission","outputs":[{"internalType":"uint256","name":"permissionId","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"permissionId","type":"uint256"}],"name":"revokePermission","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"offset","type":"uint256"},{"internalType":"uint256","name":"limit","type":"uint256"}],"name":"getUserPermissions","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserPermissionCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"permissions","outputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"address","name":"merchant","type":"address"},{"internalType":"string","name":"dataCategory","type":"string"},{"internalType":"string","name":"purpose","type":"string"},{"internalType":"uint256","name":"compensationBps","type":"uint256"},{"internalType":"uint256","name":"upfrontFee","type":"uint256"},{"internalType":"uint256","name":"validUntil","type":"uint256"},{"internalType":"uint8","name":"status","type":"uint8"},{"internalType":"uint256","name":"createdAt","type":"uint256"},{"internalType":"uint256","name":"revokedAt","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextPermissionId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSettledVolume","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];
const USDC_ABI=[{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

let prov=null,sign=null,ct=null,uc=null,addr=null;
let totalEarned=0,ownerEarned=0,settlementCount=0,agentEarnings={};

const DATA_CATS=[
  {id:'travel',name:'Travel',icon:'&#9992;&#65039;',fee:'2%',enabled:true},
  {id:'health',name:'Health',icon:'&#127973;&#65039;',fee:'3%',enabled:true},
  {id:'dining',name:'Dining',icon:'&#127869;&#65039;',fee:'2%',enabled:false},
  {id:'social_media',name:'Social Media',icon:'&#128241;',fee:'2%',enabled:false},
  {id:'streaming',name:'Streaming',icon:'&#127916;',fee:'2%',enabled:true},
  {id:'phone_carrier',name:'Phone Carrier',icon:'&#128225;',fee:'2%',enabled:false},
  {id:'credit_card',name:'Credit Card',icon:'&#128179;',fee:'2%',enabled:false,wide:true},
];

const AGENTS=[
  {name:'TravelBot v3.2',icon:'&#9992;&#65039;',color:'#0ea5e9',trust:94,erc:true},
  {name:'HealthSync',icon:'&#127973;&#65039;',color:'#22c55e',trust:87,erc:true},
  {name:'DineAI',icon:'&#127869;&#65039;',color:'#f97316',trust:71,erc:false},
  {name:'ShopAgent',icon:'&#128717;&#65039;',color:'#a855f7',trust:79,erc:true},
  {name:'SocialPulse',icon:'&#128241;',color:'#ec4899',trust:62,erc:false},
  {name:'StreamMatch',icon:'&#127916;',color:'#06b6d4',trust:85,erc:true},
  {name:'CarrierIQ',icon:'&#128225;',color:'#84cc16',trust:78,erc:false},
];

// WALLET
function openWalletModal(){document.getElementById('walletModal').classList.add('open')}
function closeModal(id){document.getElementById(id).classList.remove('open')}

function getInjectedProvider(preferCoinbase){
  const root=window.ethereum||window.coinbaseWalletExtension||window.coinbaseWallet?.ethereum||null;
  if(!root)return null;
  if(Array.isArray(root.providers)&&root.providers.length){
    if(preferCoinbase){
      return root.providers.find(p=>p&&p.isCoinbaseWallet)||root.providers[0];
    }
    return root.providers[0];
  }
  return root;
}

async function waitForInjectedProvider(preferCoinbase,timeoutMs){
  const started=Date.now();
  while(Date.now()-started<timeoutMs){
    const p=getInjectedProvider(preferCoinbase);
    if(p)return p;
    await new Promise(r=>setTimeout(r,220));
  }
  return null;
}

async function connectWallet(type){
  closeModal('walletModal');
  showToast('Detecting wallet provider...','ok');
  try{
    const raw=await waitForInjectedProvider(type==='coinbase',7000);
    if(!raw){
      showToast('No wallet detected. Tap "Open in Coinbase Wallet".','err');
      return;
    }
    prov=new ethers.BrowserProvider(raw);
    await prov.send('eth_requestAccounts',[]);
    const net=await prov.getNetwork();
    if(Number(net.chainId)!==BASE){
      try{await prov.send('wallet_switchEthereumChain',[{chainId:BASE_HEX}]);prov=new ethers.BrowserProvider(raw)}
      catch(sw){
        if(sw.code===4902){await prov.send('wallet_addEthereumChain',[{chainId:BASE_HEX,chainName:'Base',nativeCurrency:{name:'Ether',symbol:'ETH',decimals:18},rpcUrls:['https://mainnet.base.org'],blockExplorerUrls:['https://basescan.org']}]);prov=new ethers.BrowserProvider(raw)}
        else throw sw;
      }
    }
    sign=await prov.getSigner();
    addr=await sign.getAddress();
    ct=new ethers.Contract(CA,ABI,sign);
    uc=new ethers.Contract(USDC_ADDR,USDC_ABI,prov);
    await onConnected();
    raw.on('accountsChanged',a=>{if(!a||!a.length)disconnect();else{addr=a[0];onConnected()}});
    raw.on('chainChanged',()=>location.reload());
  }catch(err){
    if(err&&err.code===4001){
      showToast('Connection rejected in wallet.','err');
      return;
    }
    showToast('Connection failed: '+(err&&err.message?err.message:'unknown').slice(0,80),'err');
  }
}

async function onConnected(){
  document.getElementById('connectOverlay').classList.add('hidden');
  document.getElementById('rpAddr').textContent=sh(addr);
  await loadBalance();
  await loadOnChainData();
  buildDataLocker();
  showToast('Connected to Base Mainnet ✓','ok');
}

function disconnect(){
  prov=sign=ct=uc=null;addr=null;
  document.getElementById('connectOverlay').classList.remove('hidden');
  totalEarned=0;ownerEarned=0;settlementCount=0;agentEarnings={};
  ['phoneAmount','rpUserAmt','rpOwnerAmt','earnAmount'].forEach(id=>document.getElementById(id).textContent='$0.00');
  document.getElementById('settleList').innerHTML='';
  document.getElementById('activityList').innerHTML='';
  document.getElementById('agentEarnList').innerHTML='';
  updateStats();
}

async function loadBalance(){
  if(!uc||!addr)return;
  try{
    const raw=await uc.balanceOf(addr);
    totalEarned=Number(raw)/1e6;
    ownerEarned=totalEarned*0.03;
    updateAmounts();
  }catch(e){}
}

async function loadOnChainData(){
  if(!ct||!addr)return;
  try{
    const cnt=await ct.getUserPermissionCount(addr);
    const n=Number(cnt);
    if(n>0){
      const ids=await ct.getUserPermissions(addr,0,n);
      const perms=await Promise.all(Array.from(ids).map(id=>ct.permissions(id)));
      perms.forEach((p,i)=>{
        if(Number(p[7])===1){
          const catId=p[2];
          const agent=AGENTS.find(a=>a.name.toLowerCase().includes(catId.split('_')[0]))||AGENTS[i%AGENTS.length];
          const comp=Number(p[4])/100;
          const est=(comp/100)*25;
          addSettlement(agent,est,false);
        }
      });
      // Update enabled toggles
      perms.forEach(p=>{
        if(Number(p[7])===1){
          const cat=DATA_CATS.find(c=>c.id===p[2]);
          if(cat)cat.enabled=true;
        }
      });
      buildDataLocker();
    }
    const vol=await ct.totalSettledVolume();
    const v=Number(vol)/1e6;
    if(v>0){settlementCount=Math.floor(v/5)+1;updateStats()}
  }catch(e){}
}

function updateAmounts(){
  const fmt=v=>'$'+v.toFixed(2);
  [
    ['phoneAmount',totalEarned],
    ['rpUserAmt',totalEarned],
    ['earnAmount',totalEarned],
    ['rpOwnerAmt',ownerEarned],
  ].forEach(([id,val])=>{
    const el=document.getElementById(id);
    el.textContent=fmt(val);
    el.classList.add('flash');
    setTimeout(()=>el.classList.remove('flash'),300);
  });
  updateStats();
  const recv=document.getElementById('owRecv');
  recv.classList.add('show');
  setTimeout(()=>recv.classList.remove('show'),2500);
}

function updateStats(){
  const fmt=v=>'$'+v.toFixed(2);
  document.getElementById('rpSett').textContent=settlementCount;
  document.getElementById('rpUE').textContent=fmt(totalEarned);
  document.getElementById('rpOC').textContent=fmt(ownerEarned);
  document.getElementById('rpV').textContent=fmt(ownerEarned);
  document.getElementById('efUser').textContent=fmt(totalEarned);
  document.getElementById('efProto').textContent=fmt(ownerEarned);
}

function addSettlement(agent,amount,isNew=true){
  if(isNew){
    settlementCount++;
    totalEarned+=amount;
    ownerEarned+=amount*0.03;
    updateAmounts();
  }
  const fmt='$'+Math.abs(amount).toFixed(2);
  const list=document.getElementById('settleList');
  const el=document.createElement('div');
  el.className='si'+(isNew?' new-entry':'');
  el.innerHTML=`<div class="si-ico" style="background:${agent.color}22">${agent.icon}</div><div class="si-info"><div class="si-name">${agent.name}</div><div class="si-meta">Trust: ${agent.trust}${agent.erc?' · ERC-8004':''}</div></div><div class="si-amt pos">+${fmt}<br><span style="font-size:7px;color:var(--text3)">USDC</span></div>`;
  list.insertBefore(el,list.firstChild);
  if(list.children.length>8)list.removeChild(list.lastChild);
  const act=document.getElementById('activityList');
  const ae=document.createElement('div');
  ae.className='act-item';
  ae.innerHTML=`<div class="act-ico" style="background:${agent.color}22">${agent.icon}</div><div class="act-info"><div class="act-name">${agent.name}</div><div class="act-meta" style="color:var(--green)">SETTLED</div></div><div class="act-amt" style="color:var(--green)">+${fmt}</div>`;
  act.insertBefore(ae,act.firstChild);
  if(act.children.length>12)act.removeChild(act.lastChild);
  if(!agentEarnings[agent.name])agentEarnings[agent.name]={agent,total:0};
  agentEarnings[agent.name].total+=amount;
  buildAgentEarnList();
}

function buildAgentEarnList(){
  const list=document.getElementById('agentEarnList');
  const sorted=Object.values(agentEarnings).sort((a,b)=>b.total-a.total).slice(0,4);
  list.innerHTML='';
  sorted.forEach(({agent,total})=>{
    const el=document.createElement('div');el.className='ae-item';
    el.innerHTML=`<div class="ae-ico" style="background:${agent.color}22">${agent.icon}</div><div class="ae-info"><div class="ae-name">${agent.name}</div><div class="ae-fee">Protocol fee: $${(total*0.03).toFixed(2)}</div></div><div class="ae-amt">+$${total.toFixed(2)}</div>`;
    list.appendChild(el);
  });
}

function buildDataLocker(){
  const grid=document.getElementById('dataGrid');grid.innerHTML='';
  DATA_CATS.forEach(cat=>{
    const card=document.createElement('div');
    card.className='data-card'+(cat.enabled?' enabled':'')+(cat.wide?' wide':'');
    card.dataset.id=cat.id;
    card.innerHTML=`<div class="dc-top"><div class="dc-icon">${cat.icon}</div><div class="toggle${cat.enabled?' on':''}" data-id="${cat.id}"></div></div><div class="dc-name">${cat.name}</div><div class="dc-fee">Fee: ${cat.fee}</div>`;
    grid.appendChild(card);
    const tog=card.querySelector('.toggle');
    tog.addEventListener('click',e=>{e.stopPropagation();toggleCat(cat)});
    card.addEventListener('click',()=>toggleCat(cat));
  });
}

async function toggleCat(cat){
  if(!addr){openWalletModal();return}
  const wasEnabled=cat.enabled;
  cat.enabled=!cat.enabled;
  buildDataLocker();
  if(cat.enabled){
    openTxModal('GRANT PERMISSION');
    setTxState('pending','Granting '+cat.name+' access...','Confirm in your wallet');
    try{
      const tx=await ct.grantPermission('0x0000000000000000000000000000000000000000',cat.id,'AI agent data access — '+cat.name,BigInt(200),BigInt(0),BigInt(30*86400));
      setTxState('pending','Submitted...',sh(tx.hash));
      const r=await tx.wait();
      setTxState('ok',cat.name+' Permission Granted!','Block '+r.blockNumber+' · AI agents can now pay you');
      document.getElementById('txClose').classList.remove('hidden');
      showToast('grantPermission() confirmed ✓','ok');
      // Show settlement in wallet tab
      const agent=AGENTS.find(a=>a.name.toLowerCase().includes(cat.id.split('_')[0]))||AGENTS[0];
      addSettlement(agent,parseFloat(cat.fee)*25/100,true);
    }catch(err){
      cat.enabled=wasEnabled;buildDataLocker();
      if(err.code!==4001){setTxState('err','Transaction Failed',(err.reason||err.message||'').slice(0,100));document.getElementById('txClose').classList.remove('hidden')}
      else closeModal('txModal');
    }
  }else{
    showToast(cat.name+' data access disabled','ok');
  }
}

function openTxModal(title){
  document.getElementById('txTitle').textContent=title;
  document.getElementById('txSpin').classList.remove('hidden');
  document.getElementById('txOkIco').classList.add('hidden');
  document.getElementById('txErrIco').classList.add('hidden');
  document.getElementById('txClose').classList.add('hidden');
  document.getElementById('txModal').classList.add('open');
}
function setTxState(state,msg,sub){
  document.getElementById('txMsg').textContent=msg;
  document.getElementById('txSub').textContent=sub||'';
  if(state==='ok'){document.getElementById('txSpin').classList.add('hidden');document.getElementById('txOkIco').classList.remove('hidden')}
  if(state==='err'){document.getElementById('txSpin').classList.add('hidden');document.getElementById('txErrIco').classList.remove('hidden')}
}

function switchScreen(name,btn){
  document.querySelectorAll('.pscreen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.pnav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  const navBtn=btn||document.querySelector(`.pnav-btn[data-s="${name}"]`);
  if(navBtn)navBtn.classList.add('active');
}

function showToast(msg,type){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast show '+(type||'');
  clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),4000);
}
function sh(a){return a?a.slice(0,6)+'...'+a.slice(-4):'--'}

function openInCoinbaseWallet(){
  const cleanUrl=window.location.origin+window.location.pathname+'?connect=1';
  const deepLink='https://go.cb-w.com/dapp?cb_url='+encodeURIComponent(cleanUrl);
  window.location.href=deepLink;
}

function updateCoinbaseDeepLinkVisibility(){
  const btn=document.getElementById('openInCoinbaseBtn');
  if(!btn)return;
  if(window.ethereum){
    btn.classList.add('hidden');
  }else{
    btn.classList.remove('hidden');
  }
}

function enableSwipeNavigation(){
  const screens=['wallet','data','earn','activity'];
  const phoneScreen=document.querySelector('.phone-screen');
  if(!phoneScreen)return;

  let sx=0,sy=0;
  phoneScreen.addEventListener('touchstart',e=>{
    if(!e.touches||!e.touches.length)return;
    sx=e.touches[0].clientX;
    sy=e.touches[0].clientY;
  },{passive:true});

  phoneScreen.addEventListener('touchend',e=>{
    if(!e.changedTouches||!e.changedTouches.length)return;
    const dx=e.changedTouches[0].clientX-sx;
    const dy=e.changedTouches[0].clientY-sy;
    if(Math.abs(dx)<40||Math.abs(dx)<Math.abs(dy))return;

    const activeScreen=document.querySelector('.pscreen.active');
    if(!activeScreen)return;
    const current=(activeScreen.id||'').replace('screen-','');
    const idx=screens.indexOf(current);
    if(idx===-1)return;

    if(dx<0&&idx<screens.length-1)switchScreen(screens[idx+1]);
    if(dx>0&&idx>0)switchScreen(screens[idx-1]);
  },{passive:true});
}

(async()=>{
  buildDataLocker();
  enableSwipeNavigation();
  updateCoinbaseDeepLinkVisibility();
  const params=new URLSearchParams(window.location.search);
  if(params.get('connect')==='1')openWalletModal();
  if(!window.ethereum)return;
  try{const a=await window.ethereum.request({method:'eth_accounts'});if(a&&a.length)await connectWallet('injected')}catch(e){}
})();
</script>
</body>
</html>
